
### å‰è¨€


Â Â Â Â è¿‘ä¸¤å¹´`AIGC`å‘å±•çš„éå¸¸è¿…é€Ÿï¼Œä»åˆšå¼€å§‹çš„åªæœ‰`ChatGPT`åˆ°ç°åœ¨çš„å¾ˆç™¾å®¶äº‰é¸£ã€‚ä»å¼€å§‹çš„å¤§å‚æ•°æ¨¡å‹ï¼Œå†åˆ°åæ¥çš„å°å‚æ•°æ¨¡å‹ï¼Œä»ä¸€å¼€å§‹å•ä¸€çš„æ–‡æœ¬æ¨¡å‹åˆ°ç°åœ¨çš„å¤šæ¨¡æ€æ¨¡å‹ç­‰ç­‰ã€‚éšç€ä¸€èµ·è¿›æ­¥çš„ä¸ä»…ä»…æ˜¯æ¨¡å‹çš„å¤šæ ·åŒ–ï¼Œè¿˜æœ‰æ¨¡å‹çš„ä½¿ç”¨æ–¹å¼ã€‚å¤§æ¨¡å‹ä½¿ç”¨çš„é—¨æ§›è¶Šæ¥è¶Šä½ï¼Œç”šè‡³ç°åœ¨æ¯ä¸ªäººéƒ½å¯ä»¥åœ¨è‡ªå·±çš„ç”µè„‘ä¸Šè¿è¡Œæ¨¡å‹ã€‚ä»Šå¤©æˆ‘ä»¬è¦è¯´çš„å°±æ˜¯å¤§æ¨¡å‹å·¥å…·ä¸­çš„ä½¼ä½¼è€…`Ollama`,å¹¶æ¼”ç¤ºå¦‚ä½•é€šè¿‡`C#`æ¥ä½¿ç”¨`Ollama`ã€‚


### Ollama


Â Â Â Â `Ollama`æ˜¯ä¸€ä¸ªå¼€æºçš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰æœåŠ¡å·¥å…·ï¼Œå®ƒå…è®¸ç”¨æˆ·åœ¨æœ¬åœ°PCç¯å¢ƒå¿«é€Ÿå®éªŒã€ç®¡ç†å’Œéƒ¨ç½²å¤§å‹è¯­è¨€æ¨¡å‹ã€‚å®ƒæ”¯æŒå¤šç§æµè¡Œçš„å¼€æºå¤§å‹è¯­è¨€æ¨¡å‹ï¼Œå¦‚ `Llama 3.1`ã€`Phi 3`ã€`Qwen 2`ã€`GLM 4`ç­‰ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œç•Œé¢è½»æ¾ä¸‹è½½ã€è¿è¡Œå’Œç®¡ç†è¿™äº›æ¨¡å‹ã€‚`Ollama`çš„å‡ºç°æ˜¯ä¸ºäº†é™ä½ä½¿ç”¨å¤§å‹è¯­è¨€æ¨¡å‹çš„é—¨æ§›ï¼Œæ˜¯è®©å¤§å‹è¯­è¨€æ¨¡å‹æ›´åŠ æ™®åŠå’Œæ˜“äºè®¿é—®ã€‚ä¸€è¨€ä»¥è”½ä¹‹å°±æ˜¯`Ollamaè®©ä½¿ç”¨æ¨¡å‹æ›´ç®€å•`ã€‚æ— è®ºæ˜¯`CPU`æˆ–æ˜¯`GPU`éƒ½å¯ä»¥ï¼Œç®—åŠ›é«˜çš„è¯æ¨ç†é€Ÿåº¦æ›´å¿«ï¼Œç®—åŠ›ä¸è¶³çš„è¯æ¨ç†çš„æ…¢ï¼Œè€Œä¸”å®¹æ˜“èƒ¡è¨€ä¹±è¯­ã€‚


#### å®‰è£…


`Ollama`çš„å®‰è£…æ–¹å¼å¸¸ç”¨çš„æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯å»å®˜ç½‘ä¸‹è½½ï¼Œå¦ä¸€ç§æ˜¯å»GitHubä¸‹è½½ï¼Œå¯ä»¥é€‰æ‹©å¯¹åº”çš„ç³»ç»Ÿç‰ˆæœ¬è¿›è¡Œä¸‹è½½


* å®˜ç½‘é¦–é¡µç›´æ¥ä¸‹è½½ [https://ollama.com/](https://github.com)
* Github Relaseä¸‹è½½ [https://github.com/ollama/ollama/releases](https://github.com)


æˆ‘çš„æ˜¯Windowsæ“ä½œç³»ç»Ÿï¼Œæ‰€ä»¥ç›´æ¥ä¸‹è½½ä¸€è·¯Nextå°±å¯ä»¥ï¼Œé»˜è®¤å®‰è£…åœ¨`Cç›˜`æ— æ³•æ›´æ”¹ï¼Œå¼ºè¿«ç—‡çš„è¯å¯ä»¥é€šè¿‡`mklink`åšé“¾æ¥ï¼Œä½†æ˜¯è‡ªåŠ¨æ›´æ–°ä¹‹åè¿˜æ˜¯åœ¨`Cç›˜`ã€‚è‡ªåŠ¨å‡çº§è¿™ä¸€å—ä¸ç”¨å¤ªæ‹…å¿ƒï¼Œè”ç½‘çš„æƒ…å†µï¼Œå¦‚æœæœ‰æ–°ç‰ˆæœ¬`Ollama`ä¼šæ¨é€æ›´æ–°ã€‚


å®‰è£…å®Œæˆä¹‹åå¯ä»¥ä¿®æ”¹å¸¸ç”¨çš„ç¯å¢ƒå˜é‡


* é€šè¿‡`OLLAMA_MODELS`ç¯å¢ƒå˜é‡è®¾ç½®æ¨¡å‹ä¸‹è½½çš„ä½ç½®ï¼Œé»˜è®¤æ˜¯åœ¨`Cç›˜`ï¼Œå¯ä»¥æ¢æˆå…¶ä»–åœ°å€ã€‚
* é€šè¿‡`OLLAMA_HOST`è®¾ç½®`Ollama`æœåŠ¡ç›‘å¬çš„ç«¯å£ï¼Œé»˜è®¤çš„æ˜¯`11434`ã€‚


å®‰è£…å®Œæˆä¹‹åé€šè¿‡`version`æŸ¥çœ‹ï¼Œå¦‚æœæ˜¾ç¤ºç‰ˆæœ¬å·åˆ™å®‰è£…æˆåŠŸã€‚



```
ollama --version

```

æ¯”è¾ƒå¸¸ç”¨çš„æŒ‡ä»¤ä¸å¤šï¼Œä¹Ÿå¾ˆç®€å•


* `ollama list`åˆ—å‡ºæœ¬åœ°ä¸‹è½½çš„æ¨¡å‹
* `ollama ps`æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„æ¨¡å‹
* `ollama pull æ¨¡å‹æ ‡è¯†`ä¸‹è½½æ¨¡å‹åˆ°æœ¬åœ°ï¼Œæ¯”å¦‚æˆ‘è¦ä¸‹è½½`qwen2 7b`åˆ™ä½¿ç”¨`ollama pull qwen2:7b`
* `ollama run æ¨¡å‹æ ‡è¯†`è¿è¡Œæ¨¡å‹ï¼Œå¦‚æœå·²ä¸‹è½½åˆ™ç›´æ¥è¿è¡Œï¼Œå¦‚æœæ²¡ä¸‹è½½åˆ™å…ˆä¸‹è½½å†è¿è¡Œã€‚æ¯”å¦‚æˆ‘è¦è¿è¡Œ`qwen2 7b`å¯ä»¥ç›´æ¥è¿è¡Œ`ollama run qwen2:7b`


ä¹Ÿå¯ä»¥å°†æœ¬åœ°å·²æœ‰çš„`GGUF`æ¨¡å‹å¯¼å…¥åˆ°`Ollama`ä¸­å»ï¼Œæ“ä½œä¹Ÿå¾ˆç®€å•ã€‚


1. ç¼–å†™ä¸€ä¸ªåä¸º`Modelfile`çš„æ–‡ä»¶ï¼Œå†™å…¥ä»¥ä¸‹å†…å®¹



```
FROM æ¨¡å‹è·¯å¾„/qwen2-0_5b-instruct-q8_0.gguf

```

2. é€šè¿‡`Ollama`åˆ›å»ºæ¨¡å‹



```
ollama create qwen2:0.5b -f Modelfile

```

3. è¿è¡Œåˆšåˆ›å»ºçš„æ¨¡å‹



```
ollama run qwen2:0.5b

```

éœ€è¦æ³¨æ„çš„æ˜¯è¿è¡Œ`7B`è‡³å°‘éœ€è¦`8GB`çš„å†…å­˜æˆ–æ˜¾å­˜ï¼Œè¿è¡Œ`13B`è‡³å°‘éœ€è¦`16GB`å†…å­˜æˆ–æ˜¾å­˜ã€‚æˆ‘ç”µè„‘çš„é…ç½®ä¿¡æ¯å¦‚ä¸‹



```
å‹å·: å°æ–°Pro16 AIå…ƒå¯
CPU: AMD Ryzen 7 8845H
å†…å­˜: 32.0 GB

```

`AMD Ryzen 7 8845H`å†…ç½®`NPU`ï¼Œæ•´ä½“ç®—åŠ›è¿˜å¯ä»¥, è¿è¡Œè¿è¡Œ`13B`åŠä»¥ä¸‹çš„æ¨¡å‹æ²¡å¤ªå¤§é—®é¢˜ã€‚å½“ç„¶è¿™ç§çº§åˆ«å‚æ•°å¤§å°çš„æ¨¡å‹ä¸ä¼šæ˜¯ä¸€ä¸ªæ— æ‰€ä¸èƒ½çš„æ¨¡å‹ï¼Œè¿™ç§é‡çº§çš„æ¨¡å‹è¿è¡Œæˆæœ¬ç›¸å¯¹è¾ƒä½ï¼Œé€‚åˆåšä¸€äº›ç‰¹å®šåœºæ™¯çš„æ¨ç†ä»»åŠ¡ã€‚å¦‚æœéœ€è¦æ— æ‰€ä¸èƒ½çš„æ¨¡å‹å»ºè®®è¿˜æ˜¯ç›´æ¥ä½¿ç”¨`ChatGPT`è¿™ç§å•†ä¸šæ¨¡å‹ã€‚


#### å‘½ä»¤å¯åŠ¨


ä¸‹è½½æ¨¡å‹å®Œæˆä¹‹åå¯ä»¥æµ‹è¯•è¿è¡Œï¼Œé€šè¿‡`cmd`è¿è¡ŒæŒ‡ä»¤ï¼Œæ¯”å¦‚æˆ‘è¿è¡Œèµ·æ¥`qwen2:7b`æ¨¡å‹
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240904102931244-1275660501.png)](https://github.com)
è¿™ç§æ–¹å¼æ¯”è¾ƒç®€å•ï¼Œåªèƒ½æ˜¯æ–‡å­—å¯¹è¯çš„æ–¹å¼è€Œä¸”æ²¡æœ‰æ ·å¼ï¼Œç®€å•ç²—æš´ã€‚


#### æ¥å£è®¿é—®


`Ollama`æä¾›æœåŠ¡çš„æœ¬è´¨è¿˜æ˜¯`http`æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡httpæ¥å£çš„æ–¹å¼æ¥è°ƒç”¨`/api/generate`æ¥å£



```
curl http://localhost:11434/api/generate -d '{
  "model": "qwen2:7b",
  "prompt": "è¯·ä½ å‘Šè¯‰æˆ‘ä½ çŸ¥é“çš„å¤©æ°”æœ‰å“ªäº›ï¼Ÿç”¨jsonæ ¼å¼è¾“å‡º",
  "stream": false
}'

```

* `model`è®¾ç½®æ¨¡å‹çš„åç§°
* `prompt`æç¤ºè¯
* `stream`è®¾ç½®ä¸º`false`è¦æ±‚ä¸è¦æµå¼è¿”å›


å› ä¸ºæ˜¯ä¸€æ¬¡æ€§è¿”å›æ‰€æœ‰å†…å®¹ï¼Œæ‰€ä»¥éœ€è¦ç­‰å¾…ä¸€ä¼šï¼Œå¦‚æœéœ€è¦æµå¼è¾“å‡ºå¯ä»¥è®¾ç½®ä¸º`true`ã€‚ç­‰å¾…ä¸€ä¼šåæ¥å£è¿”å›çš„ä¿¡æ¯å¦‚ä¸‹æ‰€ç¤º



```
{
    "model": "qwen2:7b",
    "created_at": "2024-09-04T06:13:53.1082355Z",
    "response": "```json\n{\n  \"å¸¸è§å¤©æ°”\": [\n    {\n      \"ç±»å‹\": \"æ™´\",\n      \"æè¿°\": \"å¤©ç©ºæ— äº‘æˆ–æœ‰å°‘é‡é«˜è–„äº‘ï¼Œæ—¥é—´é˜³å…‰å……è¶³ã€‚\",\n      \"ç¬¦å·\": \"â˜€ï¸\"\n    },\n    {\n      \"ç±»å‹\": \"å¤šäº‘\",\n      \"æè¿°\": \"å¤§éƒ¨åˆ†å¤©ç©ºè¢«äº‘å±‚è¦†ç›–ï¼Œä½†èƒ½è§è“å¤©ï¼Œå¤ªé˜³æ—¶éšæ—¶ç°ã€‚\",\n      \"ç¬¦å·\": \"ğŸŒ¤ï¸\"\n    },\n    {\n      \"ç±»å‹\": \"é˜´å¤©\",\n      \"æè¿°\": \"å…¨å¤©æˆ–å¤§éƒ¨åˆ†æ—¶é—´äº‘é‡è¾ƒå¤šï¼Œå‡ ä¹çœ‹ä¸åˆ°é˜³å…‰ï¼Œå…‰çº¿è¾ƒæš—ã€‚\",\n      \"ç¬¦å·\": \"â˜ï¸\"\n    },\n    {\n      \"ç±»å‹\": \"é›¨\",\n      \"å­ç±»å‹\": [\n        {\n          \"ç±»å‹\": \"å°é›¨\",\n          \"æè¿°\": \"é™æ°´é‡ä¸å¤§ï¼Œé€šå¸¸ä¸ä¼šå½¢æˆç§¯æ°´ã€‚\",\n          \"ç¬¦å·\": \"ğŸŒ¦ï¸\"\n        },\n        {\n          \"ç±»å‹\": \"ä¸­é›¨\",\n          \"æè¿°\": \"é™æ°´é‡é€‚ä¸­ï¼Œå¯èƒ½ä¼šæœ‰å±€éƒ¨ç§¯æ°´ã€‚\",\n          \"ç¬¦å·\": \"ğŸŒ§ï¸\"\n        },\n        {\n          \"ç±»å‹\": \"å¤§é›¨\",\n          \"æè¿°\": \"é™æ°´é‡å¤§ï¼Œå¯èƒ½ä¼´æœ‰é›·ç”µå’Œå¼ºé£ã€‚\",\n          \"ç¬¦å·\": \"â›ˆï¸\"\n        }\n      ]\n    },\n    {\n      \"ç±»å‹\": \"é›ª\",\n      \"å­ç±»å‹\": [\n        {\n          \"ç±»å‹\": \"å°é›ª\",\n          \"æè¿°\": \"ç§¯é›ªè¾ƒè½»ï¼Œåœ°é¢å¯èƒ½ä»…å±€éƒ¨æœ‰è–„é›ªè¦†ç›–ã€‚\",\n          \"ç¬¦å·\": \"â„ï¸\"\n        },\n        {\n          \"ç±»å‹\": \"ä¸­é›ª\",\n          \"æè¿°\": \"é™é›ªé‡ä¸­ç­‰ï¼Œåœ°é¢å’Œéƒ¨åˆ†æ¤è¢«å¯èƒ½æœ‰ç§¯é›ªã€‚\",\n          \"ç¬¦å·\": \"ğŸŒ¨ï¸\"\n        },\n        {\n          \"ç±»å‹\": \"å¤§é›ª\",\n          \"æè¿°\": \"é™é›ªé‡å¾ˆå¤§ï¼Œåœ°é¢ç§¯é›ªæ·±åšï¼Œäº¤é€šå’Œç”Ÿæ´»å—ä¸¥é‡å½±å“ã€‚\",\n          \"ç¬¦å·\": \"â„ï¸ğŸ’¨\"\n        }\n      ]\n    },\n    {\n      \"ç±»å‹\": \"é›¾\",\n      \"æè¿°\": \"å¤§æ°”ä¸­çš„æ°´æ±½åœ¨åœ°é¢æˆ–è¿‘åœ°é¢å‡ç»“å½¢æˆå¤§é‡æ‚¬æµ®çš„å¾®å°æ°´æ»´æˆ–å†°æ™¶çš„ç°è±¡ã€‚\",\n      \"ç¬¦å·\": \"ğŸŒ«ï¸\"\n    },\n    {\n      \"ç±»å‹\": \"é›·é˜µé›¨\",\n      \"æè¿°\": \"çªç„¶è€ŒçŸ­æš‚çš„å¼ºé™é›¨ä¼´æœ‰é—ªç”µå’Œé›·é¸£ï¼Œé€šå¸¸æŒç»­æ—¶é—´è¾ƒçŸ­ã€‚\",\n      \"ç¬¦å·\": \"âš¡ğŸŒ§ï¸\"\n    }\n  ]\n}\n```",
    "done": true,
    "done_reason": "stop",
    "context": [
        151644,
        872,
        198,
        //...çœç•¥...
        73594
    ],
    "total_duration": 70172634700,
    "load_duration": 22311300,
    "prompt_eval_count": 19,
    "prompt_eval_duration": 151255000,
    "eval_count": 495,
    "eval_duration": 69997676000
}

```

è¿˜æœ‰ä¸€ç§æ¯”è¾ƒå¸¸ç”¨çš„æ“ä½œå°±æ˜¯å¤§å®¶æ¯”è¾ƒå…³æ³¨çš„`åµŒå…¥æ¨¡å‹`ï¼Œé€šä¿—ç‚¹å°±æ˜¯å¯¹æ–‡æœ¬æˆ–è€…å›¾ç‰‡ã€è§†é¢‘ç­‰ä¿¡æ¯è¿›è¡Œç‰¹å¾æå–è½¬æ¢æˆå‘é‡çš„æ–¹å¼ï¼Œè¿™æ—¶å€™éœ€è¦ä½¿ç”¨`/api/embed`æ¥å£,è¯·æ±‚æ ¼å¼å¦‚ä¸‹æ‰€ç¤ºï¼Œè¿™é‡Œä½¿ç”¨çš„å‘é‡åŒ–æ¨¡å‹æ˜¯`nomic-embed-text`å¤§å®¶å¯ä»¥è‡ªè¡Œå»ç”¨`ollama pull`è¿™ä¸ªæ¨¡å‹



```
curl http://localhost:11434/api/embed -d '{
  "model": "nomic-embed-text:latest",
  "input": "æˆ‘æ˜¯ä¸­å›½äººï¼Œæˆ‘çˆ±æˆ‘çš„ç¥–å›½"
}'

```

åµŒå…¥æ¥å£è¿”å›çš„æ•°æ®æ ¼å¼å¦‚ä¸‹æ‰€ç¤º



```
{
    "model": "nomic-embed-text:latest",
    "embeddings": [
        [
            0.012869273,
            0.015905218,
            -0.13998738,
            //...çœç•¥å¾ˆå¤š...
            -0.035138983,
            -0.03351391
        ]
    ],
    "total_duration": 619728100,
    "load_duration": 572422600,
    "prompt_eval_count": 12
}

```

å½“ç„¶`Ollama`æä¾›çš„æ¥å£è¿˜æœ‰å¾ˆå¤šï¼Œæ¯”å¦‚å¯¹è¯ã€æ¨¡å‹ç®¡ç†ç­‰å¾…ï¼Œè¿™é‡Œæˆ‘ä»¬å°±ä¸ä¸€ä¸€ä»‹ç»äº†ï¼Œæœ‰éœ€è¦çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥é˜…æ¥å£æ–‡æ¡£åœ°å€[https://github.com/ollama/ollama/blob/main/docs/api.md](https://github.com)


#### å¯è§†åŒ–UI


ä¸Šé¢æˆ‘ä»¬æåˆ°äº†ä¸¤ç§æ–¹å¼è®¿é—®`Ollama`æœåŠ¡ï¼Œä¸€ç§æ˜¯å‘½ä»¤è¡Œçš„æ–¹å¼ï¼Œå¦ä¸€ç§æ˜¯æ¥å£çš„æ–¹å¼ã€‚è¿™ä¸¤ç§è™½ç„¶æ–¹å¼åŸå§‹ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç•Œé¢æ“ä½œæ˜¾å¾—ç›´è§‚ï¼Œå¦‚æœä½ æƒ³é€šè¿‡ç•Œé¢çš„æ–¹å¼é€šè¿‡`Ollama`å®Œæˆå¯¹è¯æœåŠ¡ï¼Œå®˜æ–¹`Github`æ¨èçš„ä¹Ÿæ¯”è¾ƒå¤šï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹æ–‡æ¡£[https://github.com/ollama/ollama?tab\=readme\-ov\-file\#web\-\-desktop](https://github.com)ï¼Œæˆ‘é€‰ç”¨çš„æ˜¯ç¬¬ä¸€ä¸ª[Open WebUI](https://github.com)ï¼Œç®€å•çš„æ–¹å¼æ˜¯é€šè¿‡`Docker`ç›´æ¥è¿è¡Œ



```
docker run -d -p 3000:8080 -e OLLAMA_BASE_URL=https://ä½ çš„ollamaæœåŠ¡ip:11434 -v open-webui:/app/backend/data --name open-webui --restart always ghcr.io/open-webui/open-webui:main

```

äº¦æˆ–è€…å¯ä»¥é€šè¿‡æ„å»ºæºç çš„æ–¹å¼æ„å»ºå¯åŠ¨ï¼ŒæŒ‰ç…§ä¸‹é¢çš„å‘½ä»¤ä¸€æ­¥ä¸€æ­¥æ¥


1. git clone [https://github.com/open\-webui/open\-webui.git](https://github.com)
2. cd open\-webui/
3. cp \-RPp .env.example .envï¼ˆå¤åˆ¶ä¸€ä»½`.env.example`æ–‡ä»¶é‡å‘½åä¸º`.env`ã€‚Windowsç³»ç»Ÿçš„è¯ä½¿ç”¨copy .env.example .envï¼‰
4. npm install
5. npm run build
6. cd ./backend
7. conda create \-\-name open\-webui\-env python\=3\.11ï¼ˆç”¨condaåˆ›å»ºä¸€ä¸ªåä¸ºpen\-webui\-envçš„è™šæ‹Ÿç¯å¢ƒï¼‰
8. conda activate open\-webui\-envï¼ˆæ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼‰
9. pip install \-r requirements.txt \-Uï¼ˆå®‰è£…pythonä¾èµ–ï¼‰
10. bash start.shï¼ˆ Windowsæ“ä½œç³»ç»Ÿçš„è¯ç›´æ¥å¯åŠ¨start\_windowsï¼‰


å¦‚ä½ æ‰€è§ï¼Œå®ƒæ˜¯ä¾èµ–`NodeJs`å’Œ`Python`çš„ï¼Œè¿˜éœ€è¦å®‰è£…`Conda`


* ğŸ° Node.js \>\= 20\.10
* ğŸ Python \>\= 3\.11
* condaæˆ‘ç”¨çš„æ˜¯24\.5\.0


å¯åŠ¨æˆåŠŸåï¼Œåœ¨æµè§ˆå™¨ä¸Šè¾“å…¥`http://localhost:8080/`,æ³¨å†Œä¸€ä¸ªç”¨æˆ·åç™»é™†è¿›æ¥ä¹‹åç•Œé¢å¦‚ä¸‹æ‰€ç¤º
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240904151109805-1320033524.png)](https://github.com)
å¯ä»¥ç›´æ¥é€‰æ‹©æ¨¡å‹è¿›è¡Œå¯¹è¯ï¼Œç±»ä¼¼`ChatGPT`é‚£ç§å¯¹è¯é£æ ¼ã€‚


### C\#æ•´åˆOllama


ä¸Šé¢æˆ‘ä»¬äº†è§£åˆ°äº†`Ollama`çš„åŸºæœ¬å®‰è£…å’Œä½¿ç”¨ï¼Œæ˜ç™½äº†å®ƒçš„è°ƒç”¨æ˜¯åŸºäº`Httpæ¥å£`æ¥å®Œæˆçš„ã€‚å…¶å®æˆ‘ä¹Ÿå¯ä»¥å‚è€ƒæ¥å£æ–‡æ¡£è‡ªè¡Œå°è£…ä¸€å¥—è°ƒç”¨ï¼Œä½†æ˜¯æ²¡å¿…è¦, å› ä¸ºæœ‰å¾ˆå¤šç°æˆçš„SDKå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚


#### ä½¿ç”¨Ollama Sdk


è¿™é‡Œä½¿ç”¨çš„C\#çš„SDKå°±å«0llamaï¼Œå®ƒçš„Githubåœ°å€æ˜¯[https://github.com/tryAGI/Ollama](https://github.com), ä¸ºä»€ä¹ˆé€‰æ‹©å®ƒå‘¢ï¼Œå…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸ºå®ƒæ”¯æŒ`function call`,è¿™æ–¹ä¾¿æˆ‘ä»¬æ›´æ—©çš„ä½“éªŒæ–°åŠŸèƒ½ã€‚å®‰è£…å®ƒéå¸¸ç®€å•ï¼Œç›¸ä¿¡åŒå­¦ä»¬éƒ½ä¼š



```
dotnet add package Ollama --version 1.9.0

```

##### ç®€å•å¯¹è¯


ç®€å•çš„å¯¹è¯åŠŸèƒ½ä¸Šæ‰‹ä¹Ÿæ²¡ä»€ä¹ˆéš¾åº¦ï¼Œéƒ½æ˜¯ç®€å•ä»£ç 



```
string modelName = "qwen2:7b";
using var ollama = new OllamaApiClient(baseUri: new Uri("http://127.0.0.1:11434/api"));

Console.WriteLine("å¼€å§‹å¯¹è¯ï¼ï¼ï¼");
string userInput = "";
do
{
    Console.WriteLine("User:");
    userInput = Console.ReadLine()!;
    var enumerable = ollama.Completions.GenerateCompletionAsync(modelName, userInput);
    Console.WriteLine("Agent:");
    await foreach (var response in enumerable)
    {
        Console.Write($"{response.Response}");
    }
    Console.WriteLine();

} while (!string.Equals(userInput, "exit", StringComparison.OrdinalIgnoreCase));
Console.WriteLine("å¯¹è¯ç»“æŸï¼ï¼ï¼");

```

æ¨¡å‹åç§°æ˜¯å¿…é¡»è¦ä¼ é€’çš„ï¼Œè€Œä¸”é»˜è®¤çš„æ˜¯`æµå¼è¾“å‡º`,å¦‚æœæƒ³ä¸€æ¬¡è¿”å›åŒæ ·çš„æ˜¯è®¾ç½®`streamä¸ºfalse`ã€‚ç¤ºä¾‹ä½¿ç”¨çš„æ˜¯`qwen2:7b`æ¨¡å‹ã€‚æ‰§è¡Œèµ·æ¥ä¹‹åä¾¿å¯ä»¥ç›´æ¥å¯¹è¯ï¼Œå¦‚ä¸‹æ‰€ç¤º
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240905104244799-945119164.png)](https://github.com):[wgetCloudæœºåœº](https://tabijibiyori.org)
æ•´ä½“æ¥è¯´å›½äº§æ¨¡å‹é‡Œé¢`qwen2:7b`æ•´ä½“çš„æ•ˆæœè¿˜æ˜¯ä¸é”™çš„ï¼Œè‡³å°‘è¿˜ä¸æ˜¯æ‰­æ›²äº‹å®ã€‚


##### å¤šè½®å¯¹è¯


å¦‚æœéœ€è¦è¿›è¡Œåˆ†è§’è‰²çš„å¤šè½®å¯¹è¯ï¼Œè¦æ¢ä¸€ä¸ªæ–¹å¼ä½¿ç”¨ï¼Œä½¿ç”¨æä¾›çš„`Chat`æ–¹å¼ï¼Œå¦‚ä¸‹æ‰€ç¤º



```
string modelName = "glm4:9b";
using var ollama = new OllamaApiClient(baseUri: new Uri("http://127.0.0.1:11434/api"));
Console.WriteLine("å¼€å§‹å¯¹è¯ï¼ï¼ï¼");
string userInput = "";
List messages = [];
do
{
    //åªå–æœ€æ–°çš„äº”æ¡æ¶ˆæ¯
    messages = messages.TakeLast(5).ToList();
    Console.WriteLine("User:");
    userInput = Console.ReadLine()!;
    //åŠ å…¥ç”¨æˆ·æ¶ˆæ¯
    messages.Add(new Message(MessageRole.User, userInput));
    var enumerable = ollama.Chat.GenerateChatCompletionAsync(modelName, messages, stream: true);
    Console.WriteLine("Agent:");
    StringBuilder builder = new();
    await foreach (var response in enumerable)
    {
        string content = response.Message.Content;
        builder.AppendLine(content);
        Console.Write(content);
    }
    //åŠ å…¥æœºå™¨æ¶ˆæ¯
    messages.Add(new Message(MessageRole.Assistant, builder.ToString()));
    Console.WriteLine();

} while (!string.Equals(userInput, "exit", StringComparison.OrdinalIgnoreCase));
Console.WriteLine("å¯¹è¯ç»“æŸï¼ï¼ï¼");

```

è¿™æ¬¡æ¢äº†å¦ä¸€ä¸ªå›½äº§æ¨¡å‹`glm4:9b`, å¤šè½®å¯¹è¯å’Œå®Œå…¨å¯¹è¯ä½¿ç”¨çš„å¯¹è±¡ä¸åŒã€‚


* å®Œå…¨å¯¹è¯ä½¿ç”¨çš„æ˜¯Completionså¯¹è±¡ï¼Œå¤šè½®å¯¹è¯ä½¿ç”¨çš„æ˜¯`Chat`å¯¹è±¡ã€‚
* å¤šè½®å¯¹è¯éœ€è¦ç”¨`List`å­˜å‚¨ä¹‹å‰çš„å¯¹è¯è®°å½•ï¼Œè¿™é‡Œæ¨¡å‹æ‰èƒ½æ•è·ä¸Šä¸‹æ–‡ã€‚


è¿è¡Œèµ·æ¥ï¼Œæ‰§è¡Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤º
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240905105611315-1456276216.png)](https://github.com)
ç¬¬ä¸€æ¬¡æˆ‘é—®ä»–ä¼šc\#å—ï¼Œå®ƒè¯´äº†ä¸€å †è¡¨ç¤ºä¼šã€‚ç¬¬äºŒå¥æˆ‘è®©å®ƒå†™ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰è¯´å†™c\#ç¤ºä¾‹ï¼Œä½†æ˜¯å®ƒå¯ä»¥é€šè¿‡ä¸Šé¢çš„å¯¹è¯äº†è§£åˆ°æ„å›¾ï¼Œæ‰€ä»¥ç›´æ¥ç”¨c\#ç»™æˆ‘å†™äº†ä¸€ä¸ªç¤ºä¾‹ã€‚


##### function call


é«˜ç‰ˆæœ¬çš„`Ollama`æ”¯æŒ`function call`ï¼Œå½“ç„¶è¿™ä¹Ÿè¦æ±‚æ¨¡å‹ä¹Ÿå¿…é¡»æ”¯æŒï¼Œå¦‚æœæ¨¡å‹æœ¬èº«ä¸æ”¯æŒï¼Œé‚£ä¹Ÿæ˜¯æ²¡æœ‰æ•ˆæœçš„ï¼Œå…¶ä¸­`llama3.1`æ”¯æŒçš„æ¯”è¾ƒå¥½ï¼Œç¾ä¸­ä¸è¶³æ˜¯`llama3.1`å¯¹ä¸­æ–‡æ”¯æŒçš„ä¸å¤ªå¥½ï¼Œæ‰€ä»¥æˆ‘ä»¬ç®€å•çš„æ¼”ç¤ºä¸€ä¸‹ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯`llama3.1:8b`æ¨¡å‹ï¼Œé¦–å…ˆéœ€è¦å®šä¹‰æ–¹æ³•ï¼Œè¿™æ ·å’Œæ¨¡å‹å¯¹è¯çš„æ—¶å€™ï¼Œæ¡†æ¶ä¼šæŠŠæ–¹æ³•çš„å…ƒä¿¡æ¯æŠ½å‡ºæ¥å‘ç»™æ¨¡å‹ï¼Œè®©æ¨¡å‹åˆ¤æ–­è°ƒç”¨å“ªä¸ªï¼Œè¿™é‡Œæˆ‘ç®€å•å®šä¹‰äº†ä¸€ä¸ªè®¡ç®—å¢åˆ æ”¹æŸ¥çš„æ¥å£ï¼Œå¹¶å®ç°è¿™ä¸ªæ¥å£ã€‚



```
//å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œæä¾›å…ƒä¿¡æ¯
[OllamaTools]
public interface IMathFunctions
{
    [Description("Add two numbers")]
    int Add(int a, int b);
    [Description("Subtract two numbers")]
    int Subtract(int a, int b);
    [Description("Multiply two numbers")]
    int Multiply(int a, int b);
    [Description("Divide two numbers")]
    int Divide(int a, int b);
}

//å®ç°ä¸Šé¢çš„æ¥å£æä¾›å…·ä½“çš„æ“ä½œæ–¹æ³•
public class MathService : IMathFunctions
{
    public int Add(int a, int b) => a + b;
    public int Subtract(int a, int b) => a - b;
    public int Multiply(int a, int b) => a * b;
    public int Divide(int a, int b) => a / b;
}

```

æœ‰äº†ä¸Šé¢çš„æ¥å£å’Œå®ç°ç±»ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡`Ollama`ä½¿ç”¨å®ƒä»¬äº†ï¼Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹



```
string modelName = "llama3.1:8b";
using var ollama = new OllamaApiClient(baseUri: new Uri("http://127.0.0.1:11434/api"));
var chat = ollama.Chat(
    model: modelName,
    systemMessage: "You are a helpful assistant.",
    autoCallTools: true);

//ç»™Ollamaæ³¨å†Œåˆšæ‰å®šä¹‰çš„ç±»
var mathService = new MathService();
chat.AddToolService(mathService.AsTools(), mathService.AsCalls());

while (true)
{
    try
    {
        Console.WriteLine("User>");
        var newMessage = Console.ReadLine();
        var msg = await chat.SendAsync(newMessage);
        Console.WriteLine("Agent> " + msg.Content);
    }
    finally
    {
        //æ‰“å°æœ¬æ¬¡å¯¹è¯çš„æ‰€æœ‰æ¶ˆæ¯
        Console.WriteLine(chat.PrintMessages());
    }
}

```

è¿™é‡Œéœ€è¦è®¾ç½®`autoCallTools`ä¸º`true`æ‰èƒ½è‡ªåŠ¨è°ƒç”¨æ–¹æ³•ï¼Œ`PrintMessages()`æ–¹æ³•ç”¨æ¥æ‰“å°æœ¬è½®ä¼šè¯ä¸­æ‰€æœ‰çš„æ¶ˆæ¯, ä¸€èˆ¬è‡ªåŠ¨è°ƒç”¨`function call`çš„æ—¶å€™ä¼šäº§ç”Ÿå¤šæ¬¡è¯·æ±‚ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™æ˜¯æ— æ„ŸçŸ¥çš„ï¼Œå› ä¸ºæ¡†æ¶å·²å°†å¸®æˆ‘è‡ªåŠ¨å¤„ç†äº†ï¼Œæ¯”å¦‚æˆ‘çš„æç¤ºè¯æ˜¯ä¸€ä¸ªæ•°å­¦è®¡ç®—å…¬å¼`(12+8)*4/2=?`ï¼Œå¦‚ä¸‹æ‰€æ‰€ç¤º
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240905133400093-159717952.png)](https://github.com)
é€šè¿‡`PrintMessages()`æ–¹æ³•æ‰“å°çš„å¯¹è¯æ¶ˆæ¯å¯çŸ¥ï¼Œè™½ç„¶æˆ‘åªæä¾›äº†ä¸€å¥æç¤ºè¯ï¼Œä½†æ˜¯`Ollama SDK`å› ä¸ºæ”¯æŒè‡ªåŠ¨è°ƒç”¨å·¥å…·ï¼Œ`llama3.1:8b`å°†æç¤ºè¯ç®—å¼`(12+8)*4/2)`è¿›è¡Œäº†æ‹†åˆ†ï¼Œè®¡ç®—æ­¥éª¤å¦‚ä¸‹æ‰€ç¤º


* å…ˆæ‹†åˆ†äº†æ‹¬å·é‡Œçš„é€»è¾‘`12+8`å¹¶è°ƒç”¨`Add`æ–¹æ³•å¾—åˆ°ç»“æœ20
* ç„¶åç¬¬äºŒæ­¥ç”¨ä¸Šä¸€æ­¥å¾—åˆ°çš„ç»“æœè°ƒç”¨`Multiply`è®¡ç®—`20*4`å¾—åˆ°80
* å†ç”¨ä¸Šä¸€æ­¥çš„ç»“æœè°ƒç”¨`Divide`è®¡ç®—`80/2`å¾—åˆ°ç»“æœ40
* æœ€åæŠŠToolsè°ƒç”¨çš„æ­¥éª¤åŠç»“æœä¸€èµ·åœ¨é€šè¿‡å¯¹è¯å‘é€ç»™`llama3.1`æ¨¡å‹ï¼Œæ¨¡å‹å¾—åˆ°æœ€ç»ˆçš„è¾“å‡º


å¦‚æœæˆ‘ä»¬ä¸æ‰“å°è¿‡ç¨‹æ—¥å¿—çš„è¯ï¼Œæ¨¡å‹åªä¼šè¾“å‡º



```
Assistant:
The correct calculation is:
(12+8)=20
20*4=80
80/2=40
Therefore,the answer is:40.

```

##### åµŒå…¥æ¨¡å‹


ä¸Šé¢æˆ‘ä»¬æåˆ°è¿‡`Ollama`ä¸ä»…å¯ä»¥ä½¿ç”¨å¯¹è¯æ¨¡å‹è¿˜å¯ä»¥ä½¿ç”¨`åµŒå…¥æ¨¡å‹`çš„åŠŸèƒ½ï¼Œ`åµŒå…¥æ¨¡å‹`ç®€å•çš„æ¥è¯´å°±æ˜¯å¯¹æ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ç­‰åˆ©ç”¨æ¨¡å‹è¿›è¡Œç‰¹å¾æèµ·ï¼Œå¾—åˆ°å‘é‡æ•°æ®çš„è¿‡ç¨‹ã€‚é€šè¿‡`Ollama SDK`å¯ä»¥ä½¿ç”¨`Ollama`çš„åµŒå…¥åŠŸèƒ½ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º



```
 string modelName = "nomic-embed-text:latest";
 HttpClient client = new HttpClient();
 client.BaseAddress = new Uri("http://127.0.0.1:11434/api");
 client.Timeout = TimeSpan.FromSeconds(3000);
 using var ollama = new OllamaApiClient(client);
 var embeddingResp =  await ollama.Embeddings.GenerateEmbeddingAsync(modelName, "c#æ˜¯ä¸€é—¨ä¸é”™çš„ç¼–ç¨‹è¯­è¨€");
 Console.WriteLine($"[{string.Join(",", embeddingResp.Embedding!)}]");

```

å¾—åˆ°çš„å°±æ˜¯å¦‚ä¸‹æ‰€ç¤ºçš„å‘é‡ä¿¡æ¯
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240905142033490-575462444.png)](https://github.com)
å‘é‡æ•°æ®æ˜¯å¯ä»¥è®¡ç®—ç›¸ä¼¼åº¦çš„ï¼Œåˆ©ç”¨`ä½™å¼¦å¤¹è§’`çš„æ¦‚å¿µå¯ä»¥è®¡ç®—å‘é‡çš„ç©ºé—´è·ç¦»ï¼Œç©ºé—´è·ç¦»è¶Šè¿‘ï¼Œä¸¤ä¸ªå‘é‡çš„ç›¸ä¼¼åº¦ä¾¿è¶Šé«˜ã€‚å¦‚æœå¤§å®¶äº†è§£é¢œè‰²è¡¨`RGB`çš„è¯å°±æ¯”è¾ƒå®¹æ˜“ç†è§£ï¼Œä¸¾ä¸ªä¾‹å­`(255, 0, 0)`å°±æ˜¯çº¯çº¢è‰²ï¼Œ`(255, 10, 10)`ä¹Ÿæ˜¯çº¢è‰²ï¼Œä½†æ˜¯ä¸æ˜¯çº¯çº¢è‰²ã€‚å¦‚æœæŠŠ`(255, 0, 0)`å’Œ`(255, 10, 10)`æ˜ å°„åˆ°ä¸€ä¸ªä¸‰ç»´çš„ç©ºé—´åæ ‡å›¾ä¸Šå®ƒä»¬çš„è·ç¦»å°±å¾ˆè¿‘ï¼Œä½†æ˜¯å®ƒä»¬å’Œçº¯è“è‰²`(0, 0, 255)`çš„ç©ºé—´è·ç¦»å°±å¾ˆè¿œï¼Œå› ä¸ºä¸€ä¸ªè´´è¿‘`X`è½´ï¼Œä¸€ä¸ªè´´è¿‘`Z`è½´ã€‚ç°åœ¨å¤§å®¶é”ç†ŸçŸ¥çš„å‘é‡æ•°æ®åº“ï¼Œå¤§æ¦‚é‡‡ç”¨çš„å°±æ˜¯ç±»ä¼¼çš„åŸç†ã€‚ä¹Ÿæ˜¯ç°åœ¨æµè¡Œçš„`RAG`æ£€ç´¢å¢å¼ºç”Ÿæˆçš„åŸºç¡€ã€‚


æ¯”å¦‚æˆ‘æŠŠä¸‹é¢ä¸¤å¥è¯åµŒå…¥æ¨¡å‹å¾—åˆ°å‘é‡å€¼ï¼Œç„¶åé€šè¿‡è®¡ç®—`ä½™å¼¦å¤¹è§’`æ¥æ¯”è¾ƒå®ƒä»¬çš„ç›¸ä¼¼åº¦



```
var embeddingResp =  await ollama.Embeddings.GenerateEmbeddingAsync(modelName, "c#æ˜¯ä¸€é—¨ä¸é”™çš„ç¼–ç¨‹è¯­è¨€");
var embeddingResp2 = await ollama.Embeddings.GenerateEmbeddingAsync(modelName, "c#æ˜¯å¾ˆå¥½çš„è¯­è¨€");
Console.WriteLine("ç›¸ä¼¼åº¦ï¼š" + CosineSimilarity([.. embeddingResp.Embedding!], [.. embeddingResp2!.Embedding]));

//è®¡ç®—ä½™å¼¦å¤¹è§’
public static double CosineSimilarity(double[] vector1, double[] vector2)
{
    if (vector1.Length != vector2.Length)
        throw new ArgumentException("å‘é‡é•¿åº¦å¿…é¡»ç›¸åŒ");

    double dotProduct = 0.0;
    double magnitude1 = 0.0;
    double magnitude2 = 0.0;

    for (int i = 0; i < vector1.Length; i++)
    {
        dotProduct += vector1[i] * vector2[i];
        magnitude1 += vector1[i] * vector1[i];
        magnitude2 += vector2[i] * vector2[i];
    }

    magnitude1 = Math.Sqrt(magnitude1);
    magnitude2 = Math.Sqrt(magnitude2);

    if (magnitude1 == 0.0 || magnitude2 == 0.0)
        return 0.0; // é¿å…é™¤ä»¥é›¶

    return dotProduct / (magnitude1 * magnitude2);
}

```

ä¸Šé¢çš„å¾—åˆ°çš„ç›¸ä¼¼åº¦ç»“æœæ˜¯



```
ç›¸ä¼¼åº¦ï¼š0.9413230998586363

```

å› ä¸ºå®ƒä»¬ä¸¤å¥è¯è¡¨è¾¾çš„å«ä¹‰å·®ä¸å¤šï¼Œæ‰€ä»¥ç›¸ä¼¼åº¦å¾ˆé«˜ã€‚ä½†æ˜¯å¦‚æœæˆ‘è¦è®¡ç®—ä¸‹é¢çš„ä¸¤å¥è¯çš„ç›¸ä¼¼åº¦



```
var embeddingResp =  await ollama.Embeddings.GenerateEmbeddingAsync(modelName, "c#æ˜¯ä¸€é—¨ä¸é”™çš„ç¼–ç¨‹è¯­è¨€");
var embeddingResp2 = await ollama.Embeddings.GenerateEmbeddingAsync(modelName, "æˆ‘å–œæ¬¢åƒèŠ’æœå’Œè‰è“");

```

é‚£ä¹ˆåˆ©ç”¨ä½™å¼¦å€¼è®¡ç®—å‡ºæ¥å®ƒä»¬çš„ç›¸ä¼¼åº¦åªæœ‰`0.59`ï¼Œå› ä¸ºè¿™ä¸¤å¥è¯å‡ ä¹æ²¡æœ‰ä»»ä½•å…³è”ã€‚



```
ç›¸ä¼¼åº¦ï¼š0.5948448463206064

```

##### å¤šæ¨¡æ€æ¨¡å‹


åˆšå¼€å§‹çš„å¯¹è¯æ¨¡å‹éƒ½æ¯”è¾ƒå•ä¸€ï¼Œéƒ½æ˜¯ç®€å•çš„æ–‡æœ¬å¯¹è¯ï¼Œéšç€ä¸æ–­çš„å‡çº§ï¼Œæœ‰äº›æ¨¡å‹å·²ç»æ”¯æŒå¤šç§æ ¼å¼çš„è¾“å…¥è¾“å‡ºè€Œä¸ä»…ä»…æ˜¯å•ä¸€çš„æ–‡æœ¬ï¼Œæ¯”å¦‚æ”¯æŒå›¾ç‰‡ã€è§†é¢‘ã€è¯­éŸ³ç­‰ç­‰ï¼Œè¿™äº›æ¨¡å‹è¢«ç§°ä¸ºå¤šæ¨¡æ€æ¨¡å‹ã€‚ä½¿ç”¨`Ollama`æ•´åˆ`llava`æ¨¡å‹ä½“éªŒä¸€æŠŠï¼Œè¿™é‡Œæˆ‘æ˜¯ç”¨çš„æ˜¯`llava:13b`ã€‚æˆ‘åœ¨ç½‘ä¸Šéšä¾¿æ‰¾äº†ä¸€å¼ å›¾ç‰‡å­˜æ”¾æœ¬åœ°[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240905145135636-2080743229.jpg)](https://github.com)
ç”¨è¿™å¼ å›¾ç‰‡å¯¹æ¨¡å‹è¿›è¡Œæé—®ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤º



```
HttpClient client = new HttpClient();
client.BaseAddress = new Uri("http://127.0.0.1:11434/api");
client.Timeout = TimeSpan.FromSeconds(3000);
using var ollama = new OllamaApiClient(client);
string modelName = "llava:13b";
string prompt = "What is in this picture?";
System.Drawing.Image image = System.Drawing.Image.FromFile("1120.jpg");
var enumerable = ollama.Completions.GenerateCompletionAsync(modelName, prompt, images: [BitmapToBase64(image)], stream: true);
await foreach (var response in enumerable)
{
    Console.Write($"{response.Response}");
}

//Imageè½¬base64
public static string BitmapToBase64(System.Drawing.Image bitmap)
{
    MemoryStream ms1 = new MemoryStream();
    bitmap.Save(ms1, System.Drawing.Imaging.ImageFormat.Jpeg);
    byte[] arr1 = new byte[ms1.Length];
    ms1.Position = 0;
    ms1.Read(arr1, 0, (int)ms1.Length);
    ms1.Close();
    return Convert.ToBase64String(arr1);
}

```

æˆ‘ç”¨æç¤ºè¯è®©æ¨¡å‹æè¿°å›¾ç‰‡é‡Œé¢çš„å†…å®¹ï¼Œç„¶åæŠŠè¿™å¼ å›¾ç‰‡è½¬æ¢æˆ`base64`ç¼–ç æ ¼å¼ä¸€èµ·å‘é€ç»™æ¨¡å‹ï¼Œæ¨¡å‹è¿”å›çš„å†…å®¹å¦‚ä¸‹æ‰€ç¤º
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240905145851802-1222105384.png)](https://github.com)
ç¡®å®å¤Ÿå¼ºå¤§ï¼Œæè¿°çš„ä¿¡æ¯å¾ˆå‡†ç¡®ï¼Œæªè¯ä¹Ÿç›¸å½“ä¸é”™ï¼Œå¦‚æœè®©äººå»æè¿°å›¾ç‰‡ä¸­çš„å†…å®¹ï¼Œç›¸ä¿¡å¤§éƒ¨åˆ†äººæè¿°çš„ä¹Ÿæ²¡è¿™ä¹ˆå¥½ï¼Œä¸å¾—ä¸è¯´æ¨¡å‹è¶Šæ¥è¶Šå¼ºå¤§äº†ã€‚


#### ä½¿ç”¨SemanticKernel


é™¤äº†æ•´åˆ`Ollama SDK`ä»¥å¤–,ä½ è¿˜å¯ä»¥ç”¨`Semantic Kernel`æ¥æ•´åˆ`Ollama`ï¼Œæˆ‘ä»¬çŸ¥é“é»˜è®¤æƒ…å†µä¸‹`Semantic Kernel`åªèƒ½ä½¿ç”¨`OpenAI`å’Œ`Azure OpenAI`çš„æ¥å£æ ¼å¼ï¼Œä½†æ˜¯å…¶ä»–æ¨¡å‹æ¥å£å¹¶ä¸ä¸€å®šå’Œ`OpenAI`æ¥å£æ ¼å¼åšå…¼å®¹ï¼Œæœ‰æ—¶å€™ç”šè‡³å¯ä»¥é€šè¿‡`one-api`è¿™æ ·çš„æœåŠ¡æ¥é€‚é…ä¸€ä¸‹ã€‚ä¸è¿‡ä¸ç”¨æ‹…å¿ƒ`Ollama`å…¼å®¹äº†`OpenAI`æ¥å£çš„æ ¼å¼ï¼Œå³ä½¿ä¸éœ€è¦ä»»ä½•çš„é€‚é…æœåŠ¡ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œæˆ‘ä»¬åªéœ€è¦é‡æ–°é€‚é…ä¸€ä¸‹è¯·æ±‚åœ°å€å³å¯ã€‚



```
using HttpClient httpClient = new HttpClient(new RedirectingHandler());
httpClient.Timeout = TimeSpan.FromSeconds(120);

var kernelBuilder = Kernel.CreateBuilder()
    .AddOpenAIChatCompletion(
       modelId: "glm4:9b",
       apiKey: "ollama",
       httpClient: httpClient);
Kernel kernel = kernelBuilder.Build();

var chatCompletionService = kernel.GetRequiredService();
OpenAIPromptExecutionSettings openAIPromptExecutionSettings = new()
{
    ToolCallBehavior = ToolCallBehavior.AutoInvokeKernelFunctions
};

var history = new ChatHistory();
string? userInput;
do
{
    Console.Write("User > ");
    userInput = Console.ReadLine();
    history.AddUserMessage(userInput!);

    var result = chatCompletionService.GetStreamingChatMessageContentsAsync(
        history,
        executionSettings: openAIPromptExecutionSettings,
        kernel: kernel);
    string fullMessage = "";
    System.Console.Write("Assistant > ");
    await foreach (var content in result)
    {
        System.Console.Write(content.Content);
        fullMessage += content.Content;
    }
    System.Console.WriteLine();

    history.AddAssistantMessage(fullMessage);
} while (userInput is not null);


public class RedirectingHandler : HttpClientHandler
{
    protected override Task SendAsync(
        HttpRequestMessage request, CancellationToken cancellationToken)
    {
        var uriBuilder = new UriBuilder(request.RequestUri!) { Scheme = "http", Host = "localhost", Port = 11434 };
        //å¯¹è¯æ¨¡å‹
        if (request!.RequestUri!.PathAndQuery.Contains("v1/chat/completions"))
        {
            uriBuilder.Path = "/v1/chat/completions";
            request.RequestUri = uriBuilder.Uri;
        }
        //åµŒå…¥æ¨¡å‹
        if (request!.RequestUri!.PathAndQuery.Contains("v1/embeddings"))
        {
            uriBuilder.Path = "/v1/embeddings";
            request.RequestUri = uriBuilder.Uri;
        }            
        return base.SendAsync(request, cancellationToken);
    }
}

```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å›½äº§æ¨¡å‹`glm4:9b`,éœ€è¦æ³¨æ„çš„æ˜¯å› ä¸ºè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯æœ¬åœ°æœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦é€‚é…ä¸€ä¸‹æœåŠ¡çš„åœ°å€ï¼Œé€šè¿‡ç¼–å†™`RedirectingHandler`ç±»ï¼Œå¹¶ç”¨å…¶æ„é€ ä¸€ä¸ª`HttpClient`å®ä¾‹ä¼ é€’ç»™`Kernel`ã€‚ç»†å¿ƒçš„åŒå­¦å¯èƒ½å·²ç»å‘ç°äº†ï¼Œè¿™é‡Œæˆ‘è½¬å‘çš„`Ollama`æœåŠ¡çš„è·¯å¾„ä¹Ÿå˜æˆäº†å’Œ`OpenAI`æœåŠ¡ä¸€æ ·çš„è·¯å¾„ï¼Œä½†æ˜¯ä¸Šé¢æˆ‘è°ƒç”¨`Ollama`æœåŠ¡ç”¨çš„æ˜¯`/api/chat`å’Œ`/api/embed`è¿™ç§åœ°å€çš„æ¥å£ã€‚è¿™æ˜¯å› ä¸º`Ollama`ä¸ºäº†å…¼å®¹`OpenAI`çš„æ ‡å‡†ï¼Œä¸“é—¨å¼€å‘äº†ä¸€å¥—å’Œ`OpenAI`è·¯å¾„å’Œå‚æ•°éƒ½ä¸€æ ·çš„æ¥å£ï¼Œè¿™ä¸€ç‚¹æ˜¯éœ€è¦æ³¨æ„çš„ã€‚å½“ç„¶`Ollama`æš‚æ—¶è¿˜æ²¡æœ‰å…¨éƒ¨å…¼å®¹`OpenAI`æ¥å£çš„å…¨éƒ¨ç‰¹å¾ï¼Œæœ‰å…´è¶£çš„åŒå­¦å¯ä»¥å»çœ‹ä¸€ä¸‹[https://github.com/ollama/ollama/blob/main/docs/openai.md](https://github.com)æ–‡æ¡£åœ°å€ï¼Œäº†è§£æ›´è¯¦ç»†çš„å†…å®¹ã€‚


ä¸Šé¢çš„æœåŠ¡è¿è¡Œèµ·æ¥ï¼Œæˆ‘ä»¬åŒæ ·å¯ä»¥è¿›è¡Œå¯¹è¯ï¼Œæ•ˆæœå¦‚ä¸‹æ‰€ç¤º
[![](https://img2024.cnblogs.com/blog/2042116/202409/2042116-20240905160706423-26310012.png)](https://github.com)
åŒæ ·çš„ä½ å¯ä»¥é€šè¿‡`SemanticKernel`ä½¿ç”¨åµŒå…¥æ¨¡å‹çš„åŠŸèƒ½ï¼Œå¦‚ä¸‹æ‰€ç¤º



```
using HttpClient httpClient = new HttpClient(new RedirectingHandler());
httpClient.Timeout = TimeSpan.FromSeconds(120);

var kernelBuilder = Kernel.CreateBuilder()
    .AddOpenAITextEmbeddingGeneration(
       modelId:"nomic-embed-text:latest",
       apiKey:"ollama",
       httpClient: httpClient);
Kernel kernel = kernelBuilder.Build();
var embeddingService  = kernel.GetRequiredService();
var embeddings = await embeddingService.GenerateEmbeddingsAsync(["æˆ‘è§‰å¾—c#æ˜¯ä¸€é—¨ä¸é”™çš„ç¼–ç¨‹è¯­è¨€"]);
Console.WriteLine($"[{string.Join(",", embeddings[0].ToArray())}]");

```

è¿™é‡Œä¼‘è¦æ³¨æ„çš„æ˜¯`AddOpenAITextEmbeddingGeneration`æ–¹æ³•æ˜¯è¯„ä¼°æ–¹æ³•ï¼Œå°†æ¥ç‰ˆæœ¬æœ‰å¯èƒ½ä¼šåˆ é™¤çš„ï¼Œæ‰€ä»¥é»˜è®¤çš„ç”¨VSä½¿ç”¨è¯¥æ–¹æ³•ä¼šæœ‰é”™è¯¯æé†’ï¼Œå¯ä»¥åœ¨`csproj`çš„`PropertyGroup`æ ‡ç­¾ä¸­è®¾ç½®ä¸€ä¸‹`NoWarn`æ¥å¿½ç•¥è¿™ä¸ªæé†’ã€‚



```
<PropertyGroup>
   <OutputType>ExeOutputType>
   <TargetFramework>net8.0TargetFramework>
   <NoWarn>SKEXP0010;SKEXP0001NoWarn>
PropertyGroup>

```

### æ€»ç»“


Â Â Â Â æœ¬æ–‡ä»‹ç»äº†å¦‚ä½•é€šè¿‡`C#`ç»“åˆ`Ollama`å®ç°æœ¬åœ°å¤§è¯­è¨€æ¨¡å‹çš„éƒ¨ç½²ä¸è°ƒç”¨ï¼Œé‡ç‚¹æ¼”ç¤ºäº†åœ¨`C#`åº”ç”¨ä¸­é›†æˆè¯¥åŠŸèƒ½çš„å…·ä½“æ­¥éª¤ã€‚é€šè¿‡è¯¦ç»†çš„å®‰è£…æŒ‡å—ä¸ä»£ç ç¤ºä¾‹ï¼Œå¸®åŠ©å¼€å‘è€…å¿«é€Ÿä¸Šæ‰‹ã€‚


* é¦–å…ˆæˆ‘ä»¬ä»‹ç»äº†`Ollama`çš„å®‰è£…åŠåŸºæœ¬è®¾ç½®å’Œå‘½ä»¤çš„ä½¿ç”¨ã€‚
* ç„¶åä»‹ç»äº†å¦‚ä½•é€šè¿‡`Ollama`è°ƒç”¨å¤§æ¨¡å‹,æ¯”å¦‚ä½¿ç”¨`å‘½ä»¤è¡Œ`ã€`Httpæ¥å£æœåŠ¡`ã€`å¯è§†ä¹ç•Œé¢`ã€‚
* å†æ¬¡æˆ‘ä»¬æˆ‘ä»¬é€šè¿‡`C#`ä½¿ç”¨äº†`Ollama SDK`æ¥æ¼”ç¤ºäº†`å¯¹è¯æ¨¡å¼`ã€`æ–‡æœ¬åµŒå…¥`ã€`å¤šæ¨¡æ€æ¨¡å‹`å¦‚ä½•ä½¿ç”¨ï¼Œé¡ºä¾¿è¯´äº†ä¸€ä¸‹ç›¸ä¼¼åº¦è®¡ç®—ç›¸å…³ã€‚
* æœ€åï¼Œæˆ‘ä»¬å±•ç¤ºäº†é€šè¿‡`Semantic Kernel`è°ƒç”¨`Ollama`æœåŠ¡ï¼Œå› ä¸º`Ollama`å¯¹`OpenAI`çš„æ¥å£æ•°æ®æ ¼å¼åšäº†å…¼å®¹ï¼Œè™½ç„¶è¿˜æœ‰éƒ¨åˆ†æœªå…¼å®¹ï¼Œä½†æ˜¯æ—¥å¸¸ä½¿ç”¨é—®é¢˜ä¸å¤§ã€‚


Â Â Â Â é€šè¿‡æœ¬æ–‡å¸Œæœ›æ²¡æœ‰äº†è§£è¿‡å¤§æ¨¡å‹çš„åŒå­¦å¯ä»¥å…¥é—¨æˆ–è€…å¤§æ¦‚äº†è§£ä¸€ä¸‹ç›¸å…³çš„åŸºç¡€ï¼Œæ¯•ç«Ÿè¿™æ˜¯è¿‘ä¸¤å¹´æˆ–è€…æœªæ¥å‡ å¹´éƒ½æ¯”è¾ƒç«çš„ä¸€ä¸ªæ–¹å‘ã€‚å³ä½¿æˆ‘ä»¬ä¸èƒ½æ·±å…¥çš„ç ”ç©¶ä»–ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¾—çŸ¥é“å®ƒäº†è§£å®ƒçš„åŸºæœ¬åŸç†ä¸ä½¿ç”¨ã€‚æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦æŒç»­å­¦ä¹ ï¼Œå› ä¸ºè¿™äº›ä¸œè¥¿å¾ˆå¤šæ—¶å€™ç¡®å®æ˜¯å¯ä»¥ç»™æˆ‘ä»¬æä¾›æ–¹ä¾¿ã€‚æ¥è§¦å®ƒï¼Œäº†è§£å®ƒï¼Œæ‰èƒ½çœŸæ­£çš„çŸ¥é“å®ƒå¯ä»¥å¸®åŠ©æˆ‘è§£å†³ä»€ä¹ˆé—®é¢˜ã€‚




ğŸ‘‡æ¬¢è¿æ‰«ç å…³æ³¨æˆ‘çš„å…¬ä¼—å·ğŸ‘‡
[![](https://img2020.cnblogs.com/blog/2042116/202006/2042116-20200622133425514-1420050576.png)](https://github.com)

